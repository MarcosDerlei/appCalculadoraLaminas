<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <link rel="stylesheet" href="style.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle de Fita de Borda</title>
</head>

<body>
    <h1>Calculadora de Fita de Borda</h1>

    <form id="formulario">
        <label>Tipo da Peça:
            <input type="text" id="tipo" required />
        </label>

        <label>Quantidade:
            <input type="number" id="quantidade" required />
        </label>

        <label>Comprimento (cm):
            <input type="number" id="comprimento" required />
        </label>

        <label>Largura (cm):
            <input type="number" id="largura" required />
        </label>

        <label>Espessura da fita (mm):
            <select id="espessura">
                <option value="22">22 mm</option>
                <option value="45">45 mm</option>
                <option value="100">100 mm</option>
            </select>
        </label>

        <label>Quantidade de lados laminados COMPRIDOS:
            <input type="number" id="ladosCompridos" value="0" min="0" />
        </label>

        <label>Quantidade de lados laminados CURTOS:
            <input type="number" id="ladosCurtos" value="0" min="0" />
        </label>

        <button type="submit">Adicionar Peça</button>
    </form>

    <!-- Botão e câmera -->
    <button id="lerEtiqueta">Ler Etiqueta</button>
    <video id="video" width="100%" autoplay style="display:none; margin-top: 10px;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <table>
        <thead>
            <tr>
                <th>Tipo</th>
                <th>Qtd</th>
                <th>Comp. x Larg.</th>
                <th>Laminação</th>
                <th>Espessura</th>
                <th>Fita (m)</th>
            </tr>
        </thead>
        <tbody id="tabelaComponentes"></tbody>
    </table>

    <h3>Total de fita de borda: <span id="total">0</span> m</h3>
    <div style="margin-top: 20px;">
        <button id="limparBtn">Limpar Tudo</button>
        <button id="exportarBtn">Exportar CSV</button>
    </div>

    <footer style="text-align: center; margin-top: 30px;">
        apreciatta móveis
    </footer>

    <!-- Scripts -->
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const lerEtiquetaBtn = document.getElementById('lerEtiqueta');

        lerEtiquetaBtn.addEventListener('click', async () => {
            video.style.display = 'block';
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            setTimeout(async () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                video.style.display = 'none';
                stream.getTracks().forEach(track => track.stop());

                const result = await Tesseract.recognize(canvas, 'eng');
                const texto = result.data.text;
                console.log('Texto detectado:', texto);

                const textoLimpo = texto.replace(/[×xX]/g, 'x').replace(/\s+/g, ' ');

                // Extrair medidas
                const regex = /\b(\d{2,4})\s*x\s*(\d{2,4})\s*x\s*(\d{1,2})\b/;
                const match = textoLimpo.match(regex);
                if (match) {
                    const comprimento = match[1];
                    const largura = match[2];
                    const espessura = match[3];

                    document.getElementById('comprimento').value = comprimento;
                    document.getElementById('largura').value = largura;
                    document.getElementById('espessura').value = espessura;
                } else {
                    alert('Não foi possível detectar as medidas.');
                }

                // Extrair tipo da peça (ex: "Peça: Frente de gaveta")
                const matchTipo = texto.match(/peça[:\-]?\s*(.+)/i);
                if (matchTipo) {
                    const tipoExtraido = matchTipo[1].split('\n')[0].trim();
                    document.getElementById('tipo').value = tipoExtraido;
                }
            }, 3000);
        });
    </script>
</body>

</html>